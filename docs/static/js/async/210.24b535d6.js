/*! For license information please see 210.24b535d6.js.LICENSE.txt */
(self.webpackChunkrspress_doc_template=self.webpackChunkrspress_doc_template||[]).push([["210"],{36498:function(e,n,i){"use strict";i.r(n),i.d(n,{default:function(){return c}});var r=i("85893"),o=i("47423");function l(e){let n=Object.assign({h1:"h1",a:"a",p:"p",ul:"ul",li:"li",pre:"pre",code:"code",h2:"h2",ol:"ol"},(0,o.useMDXComponents)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"zookeeper-fle",children:["ZooKeeper FLE",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#zookeeper-fle",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"ZooKeeper messaging doesn't care about the exact method of electing a leader has long as the following holds:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The leader has seen the highest zxid of all the followers."}),"\n",(0,r.jsx)(n.li,{children:"A quorum of servers have committed to following the leader."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Of these two requirements only the first, the highest zxid among the followers needs to hold for correct operation."}),"\n",(0,r.jsx)(n.p,{children:"The second requirement, a quorum of followers, just needs to hold with high probability. We are going to recheck the second requirement, so if a failure happens during or after the leader election and quorum is lost, we will recover by abandoning leader activation and running another election."}),"\n",(0,r.jsx)(n.p,{children:"After leader election a single server will be designated as a leader and start waiting for followers to connect. The rest of the servers will try to connect to the leader. The leader will sync up with followers by sending any proposals they are missing, or if a follower is missing too many proposals, it will send a full snapshot of the state to the follower."}),"\n",(0,r.jsx)(n.p,{children:"Reconfig \u65F6\u4F1A\u91CD\u542F FLE\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"// \u5F53\u8282\u70B9\u8BA4\u8BC6\u5230\u5176\u4ED6\u8282\u70B9\u6709\u66F4\u9AD8\u7684 zxid \u548C\u66F4\u9AD8\u7684 sid \u65F6\uFF0C\n// \u6216\u8005\u662F\u8282\u70B9\u5DF2\u7ECF\u52A0\u5165\u4E86\u4E00\u4E2A Quorum\uFF08\u5DF2\u7ECF\u5B58\u5728\u4E00\u4E2A leader\uFF09\n// \u5C31\u4F1A\u53D1\u9001\u4E00\u4E2A Notifaction \u8BA9\u5176\u4ED6\u8282\u70B9\u77E5\u9053\u81EA\u5DF1\u5DF2\u7ECF\u4FEE\u6539\u4E86\u9009\u7968\nstatic public class Notification {\n    // Format version, introduced in 3.4.6\n    public final static int CURRENTVERSION = 0x2;\n    int version;\n\n    // Proposed leader\n    long leader;\n\n    // zxid of the proposed leader\n    long zxid;\n\n    // Epoch\n    long electionEpoch;\n\n    // Address of sender\n    long sid;\n\n    // epoch of the proposed leader\n    long peerEpoch;\n\n    QuorumVerifier qv;\n    // current state of sender\n    QuorumPeer.ServerState state;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"FLE \u5185\u90E8\u6709\u4E24\u4E2A\u961F\u5217\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"sendqueue = new LinkedBlockingQueue<ToSend>();\nrecvqueue = new LinkedBlockingQueue<Notification>();\n"})}),"\n",(0,r.jsx)(n.p,{children:"sendqueue \u5BF9\u5E94 WorkerSender \u7EBF\u7A0B\u3002revcqueue \u5BF9\u5E94 WorkerReceiver \u7EBF\u7A0B\u3002"}),"\n",(0,r.jsx)(n.p,{children:"WorkerReceiver \u505A\u7684\u4E8B\u60C5\uFF1A"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Response buffer \u89E3\u6790\u4E3A Notification"}),"\n",(0,r.jsx)(n.li,{children:"\u5F53\u6536\u5230\u6CA1\u6709\u6295\u7968\u6743\u7684\u8282\u70B9\uFF08observer \u6216\u8005 non-voting follower\uFF09\u7684\u901A\u77E5\u65F6\uFF0C\u76F4\u63A5\u8FD4\u56DE\u4E00\u4E2A\u81EA\u5DF1\u7684\u5F53\u524D\u9009\u7968"}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679C\u5F53\u524D\u8282\u70B9\u662F LOOKING \u72B6\u6001\uFF0C\u5219\u5C06\u89E3\u6790\u597D\u7684 Notification \u653E\u8FDB recvqueue","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5982\u679C\u6536\u5230\u7684 Notification \u662F LOOKING\uFF0C\u5E76\u4E14 epoch \u6BD4\u81EA\u5DF1\u4F4E\uFF0C\u5C31\u544A\u8BC9\u5BF9\u65B9\u81EA\u5DF1\u7684 epoch"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679C\u5F53\u524D\u8282\u70B9\u4E0D\u662F LOOKING \u72B6\u6001\uFF0C\u5C31\u544A\u8BC9\u5BF9\u65B9\u81EA\u5DF1\u8BA4\u4E3A\u7684 Leader \u662F\u4EC0\u4E48"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"WorkerSender \u505A\u7684\u4E8B\u60C5\uFF1A"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u6839\u636E ToSend \u4E2D sid \u4E0D\u505C\u53D1\u9001"}),"\n"]}),"\n",(0,r.jsxs)(n.h2,{id:"logicalclock",children:["logicalclock",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#logicalclock",children:"#"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"AtomicLong logicalclock = new AtomicLong(); /* Election instance */\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u521D\u59CB\u503C\u4E3A 0"}),"\n",(0,r.jsxs)(n.h2,{id:"lookforleader",children:["lookForLeader",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#lookforleader",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"\u8FDB\u5165 LOOKING \u72B6\u6001\u65F6\uFF0C\u4F1A\u8FDB\u884C lookForLeader"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"roZkMgr.start();\nreconfigFlagClear();\nif (shuttingDownLE) {\n    shuttingDownLE = false;\n    startLeaderElection();\n}\nsetCurrentVote(makeLEStrategy().lookForLeader());\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u6B64\u65F6\u5F00\u59CB\u8BA1\u65F6\uFF1A"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"if (self.start_fle == 0) {\n    self.start_fle = Time.currentElapsedTime();\n}\n\n// \u8FDB\u5165 LEADING \u6216 FOLLOWING \u72B6\u6001\u540E\uFF0Cstart_fle \u4F1A\u91CD\u7F6E\u4E3A 0\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u4E00\u5F00\u59CB\uFF0C\u7ED9\u81EA\u5DF1\u6295\u4E00\u7968\uFF0C\u5E76\u4E14\u53D1\u9001\u4E00\u8F6E\u901A\u77E5\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'synchronized(this){\n    logicalclock.incrementAndGet();\n    updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());\n}\n\nLOG.info("New election. My id =  " + self.getId() +\n        ", proposed zxid=0x" + Long.toHexString(proposedZxid));\nsendNotifications(); // \u7ED9\u5176\u4ED6\u6240\u6709\u4EBA\u90FD\u53D1\u4E00\u4E2A\u901A\u77E5\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"// notTimeout \u521D\u59CB\u503C 200ms\nint notTimeout = finalizeWait;\n\n/**\n * Determine how much time a process has to wait\n * once it believes that it has reached the end of\n * leader election.\n */\nfinal static int finalizeWait = 200;\n\n/**\n * Upper bound on the amount of time between two consecutive\n * notification checks. This impacts the amount of time to get\n * the system up again after long partitions. Currently 60 seconds.\n */\nfinal static int maxNotificationInterval = 60000;\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u5F00\u59CB\u5FAA\u73AF\uFF0C\u76F4\u5230 FLE \u505C\u6B62\u6216\u8005\u9000\u51FA LOOKING \u72B6\u6001"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"/*\n * Loop in which we exchange notifications until we find a leader\n */\n\nwhile ((self.getPeerState() == ServerState.LOOKING) && (!stop)){\n	/*\n	 * Remove next notification from queue, times out after 2 times\n	 * the termination time\n	 */\n	Notification n = recvqueue.poll(notTimeout, TimeUnit.MILLISECONDS);\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5F53 n \u4E3A null","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5982\u679C\u53D1\u9001\u961F\u5217\u90FD\u4E3A\u7A7A\uFF0C\u5219\u518D\u53D1\u4E00\u8F6E Notification"}),"\n",(0,r.jsx)(n.li,{children:"\u5426\u5219\uFF0C\u8BF4\u660E\u6709\u8FDE\u63A5\u65AD\u5F00\u4E86\uFF0C\u5219 connectAll()"}),"\n",(0,r.jsx)(n.li,{children:"\u7136\u540E\u500D\u589E notTimeout\uFF08\u6700\u5927\u503C\u4E3A maxNotificationInterval=60s\uFF09"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"\u5F53\u6295\u7968\u8005\u6216\u8005\u6295\u7968\u8005\u6295\u7684 leader \u4E0D\u662F\u6709\u6548\u8282\u70B9\uFF08\u5176\u4ED6\u96C6\u7FA4\u7684\u8282\u70B9\uFF09\u65F6\uFF0C\u5C31\u5FFD\u7565"}),"\n",(0,r.jsxs)(n.li,{children:["\u5F53\u6295\u7968\u8005\u6216\u8005\u6295\u7968\u8005\u6295\u7684 leader \u662F\u6709\u6548\u8282\u70B9\u65F6\uFF1A","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"n.electionEpoch > logicalclock.get()"}),"\n",(0,r.jsx)(n.p,{children:"\u66F4\u65B0\u81EA\u5DF1\u7684 logicalclock \u4E3A n.electionEpoch\uFF0C\u6E05\u7A7A recvset"}),"\n",(0,r.jsx)(n.p,{children:"\u5982\u679C\u6EE1\u8DB3 totalOrderPredicate\uFF0C\u5219\u66F4\u65B0\u81EA\u5DF1\u7684\u9009\u7968\u4E3A n\uFF0C\u5426\u5219\u6295\u7ED9\u81EA\u5DF1"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"n.electionEpoch < logicalclock.get()"}),"\n",(0,r.jsx)(n.p,{children:"\u5FFD\u7565\u8FD9\u4E2A Notification n"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"n.electionEpoch == logicalclock.get()"}),"\n",(0,r.jsx)(n.p,{children:"\u5982\u679C\u6EE1\u8DB3 totalOrderPredicate\uFF0C\u5219\u66F4\u65B0\u81EA\u5DF1\u7684\u9009\u7968\u4E3A n"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"recvset \u653E\u5165 n"}),"\n",(0,r.jsx)(n.p,{children:"\u5982\u679C\u5DF2\u7ECF\u5F62\u6210\u5171\u8BC6\uFF08\u6295\u7ED9\u540C\u4E2A\u8282\u70B9\u7684\u7968\u6570\u8FC7\u534A\uFF09\u5219\uFF1A"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u53CD\u590D\u4ECE recvqueue poll\uFF0Cn = recvqueue.poll(finalizeWait, TimeUnit.MILLISECONDS)\u3002","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5982\u679C\u8FD8\u80FD poll \u5230\uFF0C\u8BF4\u660E\u6709\u8282\u70B9\u6539\u53D8\u4E86\u60F3\u6CD5\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679C n \u6EE1\u8DB3 totalOrderPredicate\uFF0C\u5219\u653E\u5165 recvqueue\uFF0C\u5E76\u9000\u51FA\u5FAA\u73AF\uFF0C\u5728\u4E0B\u4E00\u4E2A\u5927\u5FAA\u73AF\u4E2D\u5904\u7406 n"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679C\u5DF2\u7ECF\u65E0\u6CD5\u4ECE recvqueue \u4E2D poll \u51FA notifaction\uFF0C\u5219\u8BF4\u660E\u6CA1\u6709\u8282\u70B9\u6539\u53D8\u60F3\u6CD5","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u6839\u636E n \u8BBE\u7F6E\u81EA\u8EAB\u72B6\u6001\u4E3A LEADING \u6216 FOLLOWING"}),"\n",(0,r.jsx)(n.li,{children:"\u9000\u51FA lookForLeader\uFF0C\u8FD4\u56DE\u8FD9\u4E2A n \u4F5C\u4E3A endVote"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u5982\u679C\u5F53\u524D\u72B6\u6001\u662F LEADING/FOLLOWING\uFF0C\u5219 lookForLeader \u4E3A\uFF1A"}),"\n",(0,r.jsx)(n.p,{children:"\u5411\u6240\u6709\u4EBA\u53D1\u9001\u7ED9\u81EA\u5DF1\u7684 notiy"}),"\n",(0,r.jsx)(n.p,{children:"\u904D\u5386 recvqueue\uFF0C\u52A0\u5165 epoch \u76F8\u540C\u7684\u5230 recvset\u3002\u6EE1\u8DB3 Quorum \u540E\uFF0C\u5219\u8FD4\u56DE endVote"}),"\n",(0,r.jsx)(n.p,{children:"\u5982\u679C\u904D\u5386 recvqueue \u65F6\uFF0Cepoch \u8DDF\u5176\u4ED6\u4EBA\u8FD4\u56DE\u7684\u4E0D\u540C\uFF0C\u5219\u52A0\u5165\u5230 outofelection"}),"\n",(0,r.jsxs)(n.h2,{id:"totalorderpredicate",children:["totalOrderPredicate",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#totalorderpredicate",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"\u8FD4\u56DE true \u5F53\u4E0B\u9762\u7684\u4EFB\u610F case \u6EE1\u8DB3\uFF1A"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"New epoch \u66F4\u9AD8"}),"\n",(0,r.jsx)(n.li,{children:"New epoch \u8DDF current epoch \u76F8\u7B49\uFF0C\u4F46\u662F new zxid \u66F4\u9AD8"}),"\n",(0,r.jsx)(n.li,{children:"New epoch \u4E0E current epoch \u76F8\u7B49\uFF0C\u5E76\u4E14 new zxid \u4E0E current zxid \u76F8\u7B49\uFF0C\u4F46\u662F sid \u66F4\u9AD8"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u5982\u4F55\u5224\u65AD notify \u6765\u81EA LOOKING \u65F6\u7684 lookForLeader\uFF1F"})]})}function t(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,o.useMDXComponents)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}var c=t;t.__RSPRESS_PAGE_META={},t.__RSPRESS_PAGE_META["notes%2Fzookeeper%2Fzookeeper-fle.md"]={toc:[{text:"logicalclock",id:"logicalclock",depth:2},{text:"lookForLeader",id:"lookforleader",depth:2},{text:"totalOrderPredicate",id:"totalorderpredicate",depth:2}],title:"ZooKeeper FLE",frontmatter:{}}}}]);